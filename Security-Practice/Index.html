<!doctype html>
<html>
  <head>
    <title>Karibu Groceries</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="container py-4">
    <h3>Product Reviews</h3>

    <form id="reviewForm">
      <input
        class="form-control mb-2"
        id="reviewText"
        placeholder="Write a review"
      />
      <button class="btn btn-danger">Submit Review</button>
    </form>

    <div id="reviews" class="mt-4"></div>

    <hr />

    <h3>Checkout</h3>
    <form action="/api/checkout" method="POST">
      <input type="hidden" name="totalPrice" value="500000" />
      <button class="btn btn-warning">Pay Now</button>
    </form>

    <script>
      document
        .getElementById("reviewForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          await fetch("/api/reviews", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              productId: "1",
              reviewText: document.getElementById("reviewText").value,
            }),
          });

          loadReviews();
        });

      async function loadReviews() {
        const res = await fetch("/api/reviews/1");
        const reviews = await res.json();
        const reviewsContainer = document.getElementById("reviews");

        reviewsContainer.innerHTML = "";

        reviews.forEach((r) => {
          // --- ORIGINAL INSECURE CODE ---
          // This line is vulnerable because it parses strings as HTML
          reviewsContainer.innerHTML += `<div class="border p-2 mb-2">${r.text}</div>`;

          // --- UNCOMMENT THE LINES BELOW TO ENABLE FRONTEND XSS PROTECTION ---
          /*
          const div = document.createElement("div");
          div.className = "border p-2 mb-2";
          // .textContent treats data as plain text, disabling any script execution
          div.textContent = r.text; 
          reviewsContainer.appendChild(div);
          
          // Note: If you uncomment the block above, you should comment out 
          // the 'reviewsContainer.innerHTML += ...' line directly above it.
          */
        });
      }

      loadReviews();
    </script>
  </body>
</html>
